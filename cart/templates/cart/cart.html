<!-- 
created by Matthew G Da Silva 11/03/2025 

It is built around the base template of the CodeInsitute Boutique Ado project cart template.

this template is the cart template for the website. It contains the cart items and the total cost of the items in the cart.
-->

{% extends 'base.html' %}

{% load static %}

{% block page_header %}
<div class="container header-container">
    <div class="row">
        <div class="col"></div>
    </div>
</div>
{% endblock %}

{% block content %}
    <div class="page-overlay h-100 w-100 top-0 position-fixed bg-light"></div>
    <div class="container mb-2">
        <div class="row">
            <div class="col">
                <h2 class="my-2">Shopping Cart</h2>
            </div>
        </div>
        <div class="row">
            <div class="col">
                {% if cart_items %}
                    <div class="table-responsive rounded">
                        <table class="table table-sm table-borderless">
                            <thead class="text-black">
                                <tr>
                                    <th scope="col">Product Info</th>
                                    <th scope="col"></th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Qty</th>
                                    <th scope="col">Subtotal</th>
                                </tr>
                            </thead>
                            {% for cart_item in cart_items %}
                                <tr>
                                    <td class="p-3 w-25">
                                        <img class="img-fluid rounded" src="{{ cart_item.item.image.url }}">
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0"><strong>{{ cart_item.item.name }}</strong></p>                                        
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0">${{ cart_item.item.price }}</p>
                                    </td>
                                    <td class="py-3 w-25">

                                        <form method="POST" >
                                            {% csrf_token %}
                                            <input type="number" name="quantity" value="{{ cart_item.quantity }}" min="1" class="form-control qty-control">
                                            <div class="mt-2">
                                                <button type="submit" name="update" class="d-none btn btn-primary btn-sm updateBtn">Update</button>
                                                <button type="submit" name="remove" class="btn btn-danger btn-sm">Remove</button>
                                            </div>
                                        </form></div>
                                    </td>
                                    <td class="py-3">
                                        <p class="my-0">${{ cart_item.item.price }}</p>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td class="pt-5 text-right">
                                    <h5>Selected Hire Dates</h5>
                                    <p>Start Date: {{ start_date }}</p>
                                    <p>End Date: {{ end_date }}</p>
                                </td>
                            </tr>                           
                            <tr>
                                <td colspan="5" class="text-right">
                                    <h4><strong>Bag Total: ${{ total|floatformat:2 }}</strong></h4>                                                                        
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right">
                                    <a href="{% url 'products' %}" class="btn btn-outline-secondary rounded-0 btn-lg">
                                        <span class="icon">
                                            <i class="fas fa-chevron-left"></i>
                                        </span>
                                        <span class="text-uppercase">Keep Shopping</span>
                                    </a>
                                    <a href="" class="btn btn-success rounded-0 btn-lg">
                                        <span class="text-uppercase">Secure Checkout</span>
                                        <span class="icon">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                    </a>
                                </td>
                            </tr>
                        </table>
                    </div>
                {% else %}
                    <p class="lead mb-5">Your bag is empty.</p>
                    <a href="{% url 'products' %}" class="btn btn-outline-black rounded-0 btn-lg">
                        <span class="icon">
                            <i class="fas fa-chevron-left"></i>
                        </span>
                        <span class="text-uppercase">Keep Shopping</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block postload_js %}
<!-- script to toggle the visibility of the formBtn bases on the qty-control input changing -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let qtyControls = document.querySelectorAll('.qty-control');
        qtyControls.forEach(qtyControl => {
            let initQty = Number(qtyControl.value);
            console.log("init qty", initQty, qtyControl); 
            qtyControl.addEventListener('change', function() {
                let formBtn = this.closest('form').querySelector('.updateBtn');
                console.log(qtyControl.value, initQty);
                if (Number(qtyControl.value) !== initQty) {
                    formBtn.classList.remove('d-none');
                } else {
                    formBtn.classList.add('d-none');
                }                
            });
        });
    });
</script>
{% endblock %}